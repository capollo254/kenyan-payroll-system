<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inactivity Logout Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #log { background: #f8f9fa; padding: 15px; margin: 15px 0; height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Inactivity Logout Test</h1>
    
    <div class="status success">
        <strong>Test Configuration:</strong>
        <ul>
            <li>Timeout: 3 minutes (180 seconds)</li>
            <li>Token Check Interval: 30 seconds</li>
            <li>Warning: 30 seconds before logout</li>
            <li>Test Token: 35fc622632b6159ce8d76cb2a4d5bbc1a6446434</li>
            <li>Test User: inactivity_test@company.com</li>
        </ul>
    </div>
    
    <div>
        <h3>Test Actions:</h3>
        <button onclick="loginWithTestToken()">Login with Test Token</button>
        <button onclick="checkTokenValidity()">Check Token Validity</button>
        <button onclick="refreshToken()">Refresh Token</button>
        <button onclick="simulateInactivity()">Simulate 4min Inactivity</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div>
        <h3>Status:</h3>
        <div id="status" class="status">Ready for testing</div>
    </div>
    
    <div>
        <h3>Log:</h3>
        <div id="log"></div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        const TEST_TOKEN = '35fc622632b6159ce8d76cb2a4d5bbc1a6446434';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `[${timestamp}] ${message}`;
            entry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function loginWithTestToken() {
            localStorage.setItem('token', TEST_TOKEN);
            localStorage.setItem('role', 'employee');
            localStorage.setItem('loginTime', new Date().toISOString());
            
            log('Test token stored in localStorage', 'success');
            updateStatus('Logged in with test token', 'success');
        }
        
        async function checkTokenValidity() {
            try {
                const response = await fetch(`${API_BASE}/auth/check-token/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${TEST_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`Token validity: ${data.valid ? 'VALID' : 'INVALID'}`, data.valid ? 'success' : 'error');
                    if (data.token_info) {
                        log(`Time remaining: ${data.token_info.time_remaining_seconds}s`);
                        log(`Last activity: ${data.token_info.last_activity}`);
                    }
                    updateStatus(`Token is ${data.valid ? 'valid' : 'invalid'}`, data.valid ? 'success' : 'error');
                } else {
                    log(`Token check failed: ${response.status} - ${data.error || 'Unknown error'}`, 'error');
                    updateStatus('Token check failed', 'error');
                }
            } catch (error) {
                log(`Error checking token: ${error.message}`, 'error');
                updateStatus('Token check error', 'error');
            }
        }
        
        async function refreshToken() {
            try {
                const response = await fetch(`${API_BASE}/auth/refresh-token/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${TEST_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`Token refreshed: ${data.message}`, 'success');
                    log(`Time remaining: ${data.time_remaining_seconds}s`);
                    updateStatus('Token refreshed successfully', 'success');
                } else {
                    log(`Token refresh failed: ${response.status} - ${data.error || 'Unknown error'}`, 'error');
                    updateStatus('Token refresh failed', 'error');
                }
            } catch (error) {
                log(`Error refreshing token: ${error.message}`, 'error');
                updateStatus('Token refresh error', 'error');
            }
        }
        
        function simulateInactivity() {
            log('Simulating 4 minutes of inactivity on backend...', 'warning');
            updateStatus('Simulating inactivity...', 'warning');
            
            // This would need to be implemented on backend
            // For now, just wait and check token
            setTimeout(() => {
                log('Checking token after simulated inactivity...');
                checkTokenValidity();
            }, 2000);
        }
        
        // Auto-check token every 10 seconds
        setInterval(() => {
            if (TEST_TOKEN) {
                checkTokenValidity();
            }
        }, 10000);
        
        // Initialize
        log('Frontend test initialized', 'success');
        log(`API Base: ${API_BASE}`);
        log(`Test Token: ${TEST_TOKEN}`);
    </script>
</body>
</html>